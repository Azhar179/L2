pipeline {
    agent any

    environment {
        LIQUIBASE_VERSION = '4.28.0'
        LIQUIBASE_HOME = "C:\\liquibase"
        DB_URL = 'jdbc:mysql://localhost:3306/liquibase15.8'
        DB_USERNAME = 'root'
        DB_PASSWORD = 'root'
        CHANGELOG_FILE = 'C:\\Users\\azbag\\Downloads\\liquibase15.8\\demo\\src\\main\\resources\\db\\changelog\\changelog-master.xml'
    }

    stages {
        stage('Install Liquibase') {
            steps {
                script {
                    // Download and install Liquibase
                    bat """
                    powershell -Command "Invoke-WebRequest -Uri https://github.com/liquibase/liquibase/releases/download/v${LIQUIBASE_VERSION}/liquibase-${LIQUIBASE_VERSION}.zip -OutFile liquibase-${LIQUIBASE_VERSION}.zip"
                    powershell -Command "Expand-Archive -Path liquibase-${LIQUIBASE_VERSION}.zip -DestinationPath ${LIQUIBASE_HOME}"
                    powershell -Command "New-Item -ItemType SymbolicLink -Path 'C:\\Program Files\\Liquibase' -Target '${LIQUIBASE_HOME}\\liquibase'"
                    """
                }
            }
        }

        stage('Apply Database Changes') {
            steps {
                script {
                    // Run Liquibase update command
                    bat """
                    liquibase --changeLogFile=${CHANGELOG_FILE} ^
                              --url=${DB_URL} ^
                              --username=${DB_USERNAME} ^
                              --password=${DB_PASSWORD} ^
                              update
                    """
                }
            }
        }
    }

    post {
        cleanup {
            // Optionally clean up the Liquibase installation
            bat 'rmdir /s /q ${LIQUIBASE_HOME}'
        }
    }
}
